<%- include('../partials/html-head') %>
<%- include('../partials/nav') %>

<div id="profile">
  <div class="padding">
    <div class="container">
      <div class="row">
          <div class="col-lg-12">
            <table class="table table-light table-striped align-middle">
              <tbody>
                  <tr>
                    <td>Leader: </td>
                    <td><%= post.leader.gamerTag %></td>
                  </tr>
                  <tr>
                    <td>Title:</td>
                    <td><%= post.title %></td>
                </tr>
                <tr>
                  <td>Queue:</td>
                  <td><%= post.queue %></td>
                </tr>
                <tr>
                  <td>Enforced Roles</td>
                  <td><%= post.eroles ? "YES" : "NO" %></td>
                </tr>
                <tr>
                  <td>Support</td>
                  <td><%= post.support1 ? "FILLED" : "NEED" %></td>
                </tr>
                <tr>
                  <td>Support</td>
                  <td><%= post.support2 ? "FILLED" : "NEEDED" %></td>
                </tr>
                <tr>
                  <td>Dps</td>
                  <td><%= post.dps1 ? "FILLED" : "NEEDED"%></td>
                </tr>
                <tr>
                  <td>Dps</td>
                  <td><%= post.dps2 ? "FILLED" : "NEEDED" %></td>
                </tr>
                <tr>
                  <td>Tank</td>
                  <td><%= post.tank1 ? "FILLED" : "NEEDED" %></td>
                </tr>
                <tr>
                  <td>Tank</td>
                  <td><%= post.tank2 ? "FILLED" : "NEEDED" %></td>
                </tr>
              </tbody>
            </table>
          </div>
      </div>
    </div>
    <% if (user.profile._id.toString() === post.leader._id.toString()) { %>
      <div class="list-group">
        <a 
          class="list-group-item list-group-item-action btn btn-warning align-center"
          role="button" 
          href="/posts/<%= post._id %>/edit"
        >
          Edit Post
        </a>
        <form action="/posts/<%= post._id %>?_method=DELETE" method="POST">
          <button>X</button>
        </form>
      </div>
    <% } %>

    <a class="nav-item nav-link" href="/posts/new">New LFG</a>
    

    <% if (!post?.collectedBy.some(profile => profile._id.equals(user.profile._id))) { %>
      <form 
        class="text-center" 
        action="/posts/<%= post._id %>/addToWall" 
        method="POST"
      >
        <button class="btn btn-primary">
          Join Group
        </button> 
      </form>
    <% } %>

    <% if (post?.collectedBy.some(profile => profile._id.equals(user.profile._id))) { %>
      <form 
        class="text-center" 
        action="/posts/<%= post.id %>/removeFromWall?_method=DELETE" 
        method="POST"
      >
        <button class="btn btn-danger">
          Remove From Collection
        </button>
      </form>
    <% } %>
    <% if (!post?.replies.some(reply => reply.author.equals(user.profile._id))) { %>
      <form action="/replies/<%= post._id %>" method="POST">
        <div class="mb-3 mt-4">
          <label 
            for="exampleFormControlTextarea1" 
            class="form-label text-light"
          >
            GROUP UP:
          </label>
          <textarea name="content" id="" cols="30" rows="10"></textarea>
          <button class="btn btn-warning"type="submit">SEND MESSAGE</button>
      </form> 
    <% } %>
    <% if (post?.replies.length) { %>
      <h2 class="text-light my-3">Replies:</h2>
      <div 
        class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g1 px-4"
      >
        <% post.replies.forEach(reply => { %>
          
          <div class="col">
            <div class="card mb-3 bg-secondary">
              <div class="row g-0">
                <div class="col-3">
                  <img 
                    src="<%= reply.author.avatar %>" 
                    class="img-fluid rounded-circle ms-2 mt-2" 
                    alt="<%= reply.author.name %>'s avatar"
                  >
                </div>
                <div class="col-9">
                  <div class="card-body">
                    <h3 class="card-title text-dark">
                      <a 
                        class="text-dark text-decoration-none" 
                        href="/profile/<%= reply.author._id %>"
                      >
                        <%= reply.author.name %>
                      </a>
                    </h3>
                    <ul class="card-text text-dark">
                      <li class="card-text text-dark"><%= reply.author.gamerTag %></li>
                      <li class="card-text text-dark"><%= reply.author.platform %></li>
                    </ul>
                    <p class="card-text text-dark"><%= reply.content %></p>
                    <a href=""></a>
                    <form action="/replies/<%= post._id %>" method="POST" class="mb-3">
                      <% if (reply.response.length) { %>
                        <h2 class="mb-3">All Replies</h2>
                      <% } %>
                      <%# This is where we'll loop over and display replies %> 
                      <% reply.response.reverse().forEach(resp => { %>
                        <section class="p-2 p-md-3 mb-3 rounded mx-4 border shadow-sm">
                          <div class="col-md-10 px-0">
                            <h4 class="mb-0 fs-5 fst-italic"> 
                              <a 
                                href="/profiles/<%= resp.author._id %>"
                                class="text-decoration-none text-dark"
                              >
                                <img
                                  src="<%= resp.author.avatar %>"
                                  class="img-fluid rounded-circle"
                                  alt="<%= reply.author.name %>'s avatar"
                                  height="35"
                                  width="35"
                                />
                                <%= resp.author.name %>
                              </a>
                              on <%= resp.createdAt.toLocaleDateString() %>
                            </h4>
                            <p class="lead my-3"><%= resp.content %> </p>
                          </div>
                        </section>
                      <% }) %>
                      <h2 class="mb-3">Write a Response</h2>
                      <div class="mb-3 mx-5">
                        <label for="reply-content" class="form-label">Reply</label>
                        <textarea 
                          class="form-control" 
                          id="reply-content" 
                          rows="3" 
                          name="content"
                        ></textarea>
                      </div>
                      <button class="btn btn-primary ms-5" type="submit">Reply</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        
        <% }) %>
      </div>
    <% } %>
  </div>
</div>
<%- include('../partials/footer') %>